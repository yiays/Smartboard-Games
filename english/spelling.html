<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spelling üêù</title>
  <meta name="description" content="Hear a word, see the definition, and try your best to spell it!">
  <meta name="tags" content="spelling, bee, challenge, typing, keyboard">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/common.css?v=14.7" rel="stylesheet">
  <style>
    audio {
      width: 15em;
      height: 2em;
      margin: 0;
    }
    .media-loader {
      height: 2em;
    }
  </style>
</head>
<body>
  <div id="menu" class="panel">
    <h1>Spelling üêù</h1>
    <p>Hear a word, see the definition, and try your best to spell it!</p>
    <button class="big-red btn" id="start">Go</button>
    <div class="options" style="margin-top: 1em">
      <button class="btn action-leaderboard">View leaderboard</button>
      <a class="btn" href="/">More games</a>
    </div>
    <p class="panel-controls">
      <label for="modeswitch">Difficulty: </label>
      <select id="modeswitch" autofocus>
        <option value="0" selected>Easy</option>
        <option value="1">Medium</option>
        <option value="2">Hard</option>
      </select>
    </p>
  </div>
  <div id="game" class="panel" style="display:none;">
    <h1 id="question">Word 1</h1>
    <div class="media-loader">
      <audio id="audio" controls src=""></audio>
    </div>
    <p id="definition">Definition: </p>
    <p id="input">_</p>
    <br>
    <div class="options">
      <button class="btn confirm-action action-cancel">Menu</button>
      <button class="btn action-check disabled">Check answer</button>
    </div>
  </div>
  <div id="results" class="panel" style="display:none;">
    <h1>Correct / Incorrect</h1>
    <p id="worddiff"></p>
    <div class="options">
      <button class="btn action-cancel confirm-action">Menu</button>
      <button class="btn action-next">Next word</button>
    </div>
  </div>
  <div id="summary" class="panel" style="display:none;">
    <h1>Finished</h1>
    <p id="finalscore"></p>
    <div class="options">
      <button class="btn action-cancel confirm-action">Menu</button>
      <button class="btn action-finish">Submit highscore</button>
    </div>
  </div>
  <div id="leaderboard" class="panel" style="display:none;">
    <h1>Leaderboard</h1>
    <p id="leaderboard-difficulty">
      (Easy)
    </p>
    <table id="board" width="100%">
      <thead>
        <th>Place</th><th>Name</th><th>Score</th>
      </thead>
      <tbody>
        <td>--</td><td>-----</td><td>---</td>
      </tbody>
    </table>
    <br>
    <div class="options">
      <button class="btn action-cancel">Back</button>
    </div>
  </div>
  <div id="keyboard" style="display:none;">
    <button class="btn action-toggle-keyboard">‚å®Ô∏è</button>
    <div class="row">
      <button class="btn action-type">Q</button>
      <button class="btn action-type">W</button>
      <button class="btn action-type">E</button>
      <button class="btn action-type">R</button>
      <button class="btn action-type">T</button>
      <button class="btn action-type">Y</button>
      <button class="btn action-type">U</button>
      <button class="btn action-type">I</button>
      <button class="btn action-type">O</button>
      <button class="btn action-type">P</button>
    </div>
    <div class="row">
      <button class="btn action-type">A</button>
      <button class="btn action-type">S</button>
      <button class="btn action-type">D</button>
      <button class="btn action-type">F</button>
      <button class="btn action-type">G</button>
      <button class="btn action-type">H</button>
      <button class="btn action-type">J</button>
      <button class="btn action-type">K</button>
      <button class="btn action-type">L</button>
    </div>
    <div class="row">
      <button class="btn action-type">Z</button>
      <button class="btn action-type">X</button>
      <button class="btn action-type">C</button>
      <button class="btn action-type">V</button>
      <button class="btn action-type">B</button>
      <button class="btn action-type">N</button>
      <button class="btn action-type">M</button>
      <button class="btn action-untype">&lt;&times;</button>
    </div>
  </div>

  <script src="//cdn.yiays.com/jquery-3.6.0.min.js"></script>
  <script src="/common.js?v=14.6"></script>
  <script>
    const words = {
      0: {
        'answer': "A response to a question",
        'brother': "A male sibling",
        'chocolate': "A sweet made of cocoa, butter, and milk",
        'couple': "A group of two",
        'greed': "Selfish desire for something",
        'knit': "Creating clothing and other objects out of wool",
        'maximum': "The most it can possibly be",
        'medal': "A form of badge that marks an achievement",
        'million': "The number 1,000,000",
        'sparkle': "To emit a rapidly changing light"
      },
      1: {
        'acronym': "A sentence where the first letter of each word can spell a word",
        'apricot': "An orange fruit with a core",
        'autumn': "The season in which trees lose their leaves",
        'congratulate': "To praise somebody who has made an achievement",
        'determined': "Possessing or displaying resolve",
        'hackable': "Easily exploited and broken open",
        'labour': "Work that is often physically straining",
        'throwable': "Capable of being tossed",
        'vanity': "To be prideful about your appearance"
        // TODO: find 1 more
      },
      2: {
        'communal': "Shared objects which anyone in a community can share",
        'congratulations': "To praise somebody who has made an achievement",
        'maroon': "A shade of purple and a ship stuck on land",
        'millennium': "A one thousand year anniversary",
        'miscellaneous': "Anything that doesn't fit in other categories",
        'oligarchy': "A small group of people that maintain control over a country",
        'phenomenon': "An unusual happening",
        'spontaneity': "To be unpredictable and make decisions on a whim"
        // TODO: find 2 more
      }
    }
    let word, wordorder, input, answers, norepeat;
    let difficulty = 0;
    const diffname = ['Easy', 'Medium', 'Hard'];
    const animparams = {distance: 5, speed: 50, times: 2};

    $().ready(() => {
      $('#modeswitch').on('change', on_modechange);

      $('#start').on('click', newgame);

      $('.action-toggle-keyboard').on('click', toggle_keyboard);

      $('.action-type').on(
        'click',
        (e) => type(e.target.textContent)
      );
      $('.action-untype').on('click', untype);
      init_keyboard_capture();

      $('.action-cancel').on('click', menu);

      $('.action-check').on('click', checkanswer)

      $('.action-next').on('click', newquestion);

      $('.action-leaderboard').on('click', showleaderboard);

      $('.action-finish').on('click', endgame);
    });

    function on_modechange() {
      difficulty = Number(this.value);
      if($('#leaderboard').is(':visible')) showleaderboard();
    }

    function menu() {
      $('#game,#results,#leaderboard,#keyboard').hide();
      $('body').removeClass('keyboard');
      $('#menu').show();
    }

    function newgame() {
      $('#menu,#results,#leaderboard').hide();
      $('#keyboard').show();
      $('body').addClass('keyboard');
      answers = [];
      norepeat = [];
      wordorder = shuffle(Object.keys(words[difficulty]));
      newquestion();
    }

    function newquestion() {
      $('#results').hide();
      $('#game').show();
      $('#question').text(`Word ${answers.length+1}`);
      input = '';
      $('#input').text('_');
      $('.action-check').addClass('disabled');

      word = wordorder[answers.length];
      $('.media-loader').removeClass('loaded');
      $('#audio').attr('src', `/audio/pronunciation/${word}.ogg`);
      $('#definition').text(`Definition: ${words[difficulty][word]}`);
    }

    function checkanswer() {
      $('#game').hide();
      let check = input.toLowerCase();
      answers.push(check);

      if(check == word) {
        $('#results>h1').text('Correct');
        $('#worddiff').html(check.toUpperCase()).addClass('correct');
      }
      else {
        shake($('#game'), animparams);
        $('#results>h1').text('Incorrect');
        $('#worddiff').html(`<span class="incorrect squiggle">${check.toUpperCase()}</span> <span class="correct">${word.toUpperCase()}</span>`).removeClass('correct');
      }

      $('#results').show();
    }

    function endgame() {
      $('#menu,#game,#keyboard').hide();
      $('body').removeClass('keyboard');
      $('#results').show();
      
      $('#finalscore').text(answers.length);
      $('#finalscore').prop('title', answers.join('\n'));
      $('#word').text(word);
      let anagrams = answers.filter((e) => {return e.length == word.length});
      $('#anagrams').text(anagrams.length);
      $('#anagrams').prop('title', anagrams.join('\n'));

      submit_highscore(`spelling_${difficulty}`, `[${anagrams.length},${answers.length}]`);
    }

    function showleaderboard() {
      $('#results,#menu,#game,#keyboard').hide();
      $('#leaderboard').show();
      $('body').removeClass('keyboard');

      $('#leaderboard-word').text(`(${diffname[difficulty]})`);

      get_leaderboard(
        `spelling_${difficulty}`,
        result_converter=(value) => `${value[0]} Anagram(s), ${value[1]} Word(s)`,
        sorter=(a,b) => (a[2][0]===b[2][0])?b[2][1]-a[2][1]:b[2][0]-a[2][0]
      );
    }

    function type(letter) {
      input += letter;
      $('#input').text(input + '_');
      $('.action-check').removeClass('disabled');
    }
    function untype() {
      if (input.length) {
        var letter = input.charAt(input.length - 1);
        input = input.slice(0, -1);
        $('#input').text(input + '_');
      } else {
        shake($('#game'), animparams);
      }
      if(input.length == 0)
        $('.action-check').addClass('disabled');
    }
  </script>
</body>
</html>