<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anagrams</title>
  <meta name="description" content="Spell as many words as you can using the letters of another word.">
  <meta name="tags" content="spelling, anagrams, challenge, typing, keyboard">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/common.css?v=8.8" rel="stylesheet">
  <style>
    body {
      margin-top: 2rem;
    }
    #found {
      max-height: 8rem;
      overflow-y: auto;
    }
    #keyboard > .row > .btn::after {
      content: attr(data-count);
      display: inline-block;
      position: absolute;
      font-size: 0.5em;
      top: 0.3em;
      right: 0.3em;
      color: grey;
    }
  </style>
</head>
<body>
  <select name="word" id="modeswitch" class="panel-controls">
    <option selected value="">Select a word</option>
  </select>
  <div id="menu" class="panel">
    <h1>Anagrams</h1>
    <p>Spell as many words as you can with the letters of another word.</p>
    <div class="loader">Loading...</div>
    <a class="big-red btn disabled" id="start" href="#" style="display:none">Go</a>
    <div class="options" style="margin-top: 1em">
      <a class="btn action-leaderboard disabled" href="#">View leaderboard</a>
      <a class="btn" href="/">More games</a>
    </div>
  </div>
  <div id="game" class="panel" style="display:none;">
    <h1 id="question">Question</h1>
    <p id="input">_</p>
    <p id="found"></p>
    <br>
    <div class="options">
      <a class="btn confirm-action action-cancel" href="#">Menu</a>
      <a class="btn action-finish" href="#">Finish</a>
    </div>
  </div>
  <div id="results" class="panel" style="display:none;">
    <h1>Results</h1>
    <p>
      You managed to find <span id="finalscore">0</span> words that can be spelt with the
      letters of <span id="word">word</span>, <attr id="anagrams">0</attr> of which
      were anagrams!
    </p>
    <div class="options">
      <a class="btn action-cancel" href="#">Menu</a>
      <a class="btn action-leaderboard" href="#">View leaderboard</a>
    </div>
  </div>
  <div id="leaderboard" class="panel" style="display:none;">
    <h1>Leaderboard</h1>
    <p id="leaderboard-word">
      WORD
    </p>
    <table id="board" width="100%">
      <thead>
        <th>Place</th><th>Name</th><th>Score</th>
      </thead>
      <tbody>
        <td>--</td><td>-----</td><td>---</td>
      </tbody>
    </table>
    <br>
    <div class="options">
      <a class="btn action-cancel" href="#">Back</a>
    </div>
  </div>
  <div id="keyboard" style="display:none;">
    <a href="#" class="btn action-toggle-keyboard">⌨️</a>
    <div class="row">
      <a href="#" class="btn action-type" data-count="0">Q</a>
      <a href="#" class="btn action-type" data-count="0">W</a>
      <a href="#" class="btn action-type" data-count="0">E</a>
      <a href="#" class="btn action-type" data-count="0">R</a>
      <a href="#" class="btn action-type" data-count="0">T</a>
      <a href="#" class="btn action-type" data-count="0">Y</a>
      <a href="#" class="btn action-type" data-count="0">U</a>
      <a href="#" class="btn action-type" data-count="0">I</a>
      <a href="#" class="btn action-type" data-count="0">O</a>
      <a href="#" class="btn action-type" data-count="0">P</a>
    </div>
    <div class="row">
      <a href="#" class="btn action-type" data-count="0">A</a>
      <a href="#" class="btn action-type" data-count="0">S</a>
      <a href="#" class="btn action-type" data-count="0">D</a>
      <a href="#" class="btn action-type" data-count="0">F</a>
      <a href="#" class="btn action-type" data-count="0">G</a>
      <a href="#" class="btn action-type" data-count="0">H</a>
      <a href="#" class="btn action-type" data-count="0">J</a>
      <a href="#" class="btn action-type" data-count="0">K</a>
      <a href="#" class="btn action-type" data-count="0">L</a>
    </div>
    <div class="row" style="padding-left:0.6em;">
      <a href="#" class="btn action-type" data-count="0">Z</a>
      <a href="#" class="btn action-type" data-count="0">X</a>
      <a href="#" class="btn action-type" data-count="0">C</a>
      <a href="#" class="btn action-type" data-count="0">V</a>
      <a href="#" class="btn action-type" data-count="0">B</a>
      <a href="#" class="btn action-type" data-count="0">N</a>
      <a href="#" class="btn action-type" data-count="0">M</a>
      <a href="#" class="btn action-untype">&lt;&times;</a>
      <a href="#" class="btn action-submit">✓</a>
    </div>
  </div>

  <script src="//cdn.yiays.com/jquery-3.6.0.min.js"></script>
  <!-- <script src="/jquery-3.6.0.min.js"></script> -->
  <script src="//cdn.yiays.com/jquery-color.min.js"></script>
  <script src="/common.js?v=9.2"></script>
  <script>
    const words = [
      "truest",
      "peach",
      "players",
      "study",
      "conversation",
      "astronomer",
      "incredible",
      "unidentifiably",
      "triangulated",
      "mountaineers",
      "computerised",
      "disagreement",
      "replications",
      "resistance",
      "creative",
      "parental",
      "statement"
    ];
    let dictionary = [];
    let word, keys, input, answers;
    const animparams = {distance: 5, speed: 50, times: 2}

    $().ready(() => {
      $.get('dictionary.txt?v=4.1')
      .done((data) => {dictionary = data.split(/\r?\n/);load_complete()})
      .fail(() => {alert("Failed to get the dictionary! Try reloading the page...")});

      words.forEach((w) => {
        $('#modeswitch').append(`<option value="${w}">${w.toUpperCase()}</option>`);
      });

      $('#modeswitch').on('change', on_modechange);

      $('#start').on('click', newgame);

      $('.action-toggle-keyboard').on('click', toggle_keyboard);

      $('.action-type').on(
        'click',
        (e) => type(e.target.textContent.toUpperCase())
      );
      $('.action-untype').on('click', untype);
      init_keyboard_capture();

      $('.action-cancel').on('click', menu);

      $('.action-results').on('click', (e) => {
        e.preventDefault();

        $('#leaderboard').hide();
        $('#results').show();
      })

      $('.action-submit').on('click', checkanswer);

      $('.action-leaderboard').on('click', showleaderboard);

      $('.action-finish').on('click', endgame);
    });

    function on_modechange() {
      word = this.value;
      if(word.length) {
        $('#start,.action-leaderboard').removeClass('disabled');
        if($('#leaderboard').is(':visible')) showleaderboard();
      }
      else {
        $('#start,.action-leaderboard').addClass('disabled');
        if($('#leaderboard').is(':visible')) menu();
      }
    }

    function menu() {
      $('#game,#results,#leaderboard,#keyboard').hide();
      $('#menu,#modeswitch').show();
      $('body').removeClass('keyboard');
    }

    function newgame() {
      if(word) {
        $('#menu,#results,#leaderboard,#modeswitch').hide();
        input = '';
        $('#input').text('_');
        $('#game,#keyboard').show();
        $('body').addClass('keyboard');
        answers = [];
        $('#question').text(word.toUpperCase());
        resetkeys();
      }
    }

    function resetkeys() {
      keys = {
        'Q':0,'W':0,'E':0,'R':0,'T':0,'Y':0,'U':0,'I':0,'O':0,'P':0,
        'A':0,'S':0,'D':0,'F':0,'G':0,'H':0,'J':0,'K':0,'L':0,
        'Z':0,'X':0,'C':0,'V':0,'B':0,'N':0,'M':0
      }
      for(var i=0; i<word.length; i++) {
        var letter = word.charAt(i).toUpperCase();
        keys[letter] += 1;
      }

      $('.action-type').each((i, el) => {
        $(el).attr('data-count', keys[$(el).text()]);
        if(keys[$(el).text()] > 0)
          $(el).removeClass('disabled');
        else
          $(el).addClass('disabled');
      });

      $('#found').text(answers.join(', ').toUpperCase())
      .animate({scrollTop: $('#found')[0].scrollHeight}, 300);

    }

    function checkanswer() {
      let check = input.toLowerCase();

      if(check == word) {
        $('#game').shake(animparams);
        return;
      }
      if(answers.indexOf(check) >= 0) {
        $('#game').shake(animparams);
        return;
      }
      if(dictionary.indexOf(check) == -1) {
        $('#game').shake(animparams);
        return;
      }
      answers.push(check);
      input = '';
      $('#input').text('_');
      resetkeys();
    }

    function endgame() {
      if(!confirm("After finishing, you can't enter any more words. Continue?")) return;

      $('#menu,#game,#keyboard').hide();
      $('#results').show();
      $('body').removeClass('keyboard');
      
      $('#finalscore').text(answers.length);
      $('#finalscore').prop('title', answers.join('\n'));
      $('#word').text(word);
      let anagrams = answers.filter((e) => {return e.length == word.length});
      $('#anagrams').text(anagrams.length);
      $('#anagrams').prop('title', anagrams.join('\n'));

      submit_highscore(`anagrams_${word}`, `[${anagrams.length},${answers.length}]`, null, 1235);
    }

    function showleaderboard() {
      $('#results,#menu,#game,#keyboard').hide();
      $('#leaderboard,#modeswitch').show();
      $('body').removeClass('keyboard');

      $('#leaderboard-word').text(`(${word.toUpperCase()})`);

      get_leaderboard(`anagrams_${word}`,
                      result_converter=(value) => `${value[0]} Anagram(s), ${value[1]} Word(s)`,
                      sorter=(a,b) => (a[2][0]===b[2][0])?b[2][1]-a[2][1]:b[2][0]-a[2][0]);
    }

    function type(letter) {
      if(keys[letter] > 0) {
        input += letter;
        $('#input').text(input + '_');

        keys[letter] -= 1
        $(`.action-type:contains('${letter}')`).attr('data-count', keys[letter]);
        if(keys[letter] <= 0) {
          $(`.action-type:contains('${letter}')`).addClass('disabled');
        }
      }else{
        $('#game').shake(animparams);
      }
    }
    function untype() {
      if (input.length) {
        var letter = input.charAt(input.length - 1);
        input = input.slice(0, -1);
        keys[letter] += 1;
        $(`.action-type:contains('${letter}')`).attr('data-count', keys[letter]);
        $(`.action-type:contains('${letter}')`).removeClass('disabled');
        $('#input').text(input + '_');
      } else {
        $('#game').shake(animparams);
      }
    }
  </script>
</body>
</html>