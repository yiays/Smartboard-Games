<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flashcards</title>
  <meta name="description" content="Train your memory with a variety of pre-made flashcards for learning languages">
  <meta name="tags" content="test, quiz, flashcard, language, memory">

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="64x64" href="/ico/64.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/common.css" rel="stylesheet">
  <style>
    body:not(.quiz) .onquiz {
      display: none!important;
    }
    body.quiz .noquiz {
      display: none!important;
    }
    #game {
      perspective: 1000px;
    }
    .flashcard {
      position: relative;
      width: 10em;
      height: 6em;
      background: var(--bg);
      border-radius: 1em;
      box-shadow: rgba(0,0,0,0.25) 0.25rem 0.25rem 0.25rem 0;
      --a-visibility: visible;
      --b-visibility: hidden;
    }
    .flashcard.flipped {
      animation: flipcard 500ms ease forwards;
    }
    .flashcard .side-a, .flashcard .side-b {
      display: grid;
      position: absolute;
      inset: 0;
      align-content: center;
    }
    .flashcard .side-a {
      font-size: 4em;
      visibility: var(--a-visibility);
    }
    .flashcard .side-b {
      visibility: var(--b-visibility);
      transform: rotateY(180deg);
    }
    @keyframes flipcard {
      0% {
        transform: rotateY(0deg);
        background: var(--bg);
        --a-visibility: visible;
        --b-visibility: hidden;
      }
      100% {
        transform: rotateY(-180deg);
        background: var(--accent);
        --a-visibility: hidden;
        --b-visibility: visible;
      }
    }
    #answers {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 0.5em;
      justify-content: center;
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <div id="menu" class="panel">
    <p class="panel-controls">
      <input type="checkbox" name="quiz" id="quiztoggle">
      <label for="quiztoggle">Quiz mode</label>
    </p>
    <h1 class="noquiz">Flashcards</h1>
    <p class="noquiz">
      Train your memory with a variety of pre-made flashcards for learning languages
    </p>
    <h1 class="onquiz">Flashcards Quiz</h1>
    <p class="onquiz">
      Choose the answer to flashcards with multiple choice questions
    </p>
    <select name="set" id="setselect" style="margin-bottom: 0.5em; margin-top: -0.5em;">
      <option selected value="">Select a set</option>
    </select>
    <div class="loader">Loading...</div>
    <button class="big-red btn disabled" id="start" style="display:none;">Go</button>
    <div class="options" style="margin-top: 1em">
      <button class="btn action-leaderboard disabled online onquiz">View leaderboard</button>
      <a class="btn" href="/">More games</a>
    </div>
  </div>
  <div id="game" class="panel" style="display:none;">
    <div class="panel-controls onquiz">
      Score: <span class="score">0</span>
    </div>

    <h1 id="question">Card 0/0</h1>
    <div class="flashcard">
      <div class="side-a">
        Question
      </div>
      <div class="side-b">
        Answer
      </div>
    </div>
    <br>

    <div id="answers" class="onquiz">
      <button type="button" class="btn action-answer">1</button>
      <button type="button" class="btn action-answer">2</button>
      <button type="button" class="btn action-answer">3</button>
      <button type="button" class="btn action-answer">4</button>
    </div>

    <div class="pre">
      <div class="options">
        <button class="btn action-cancel">Menu</button>
        <button class="btn action-answer noquiz">Show answer</button>
      </div>
    </div>
    <div class="post">
      <div class="options">
        <button class="btn action-cancel">Menu</button>
        <button class="btn action-advance">Next question</button>
      </div>
    </div>
  </div>

  <div id="results" class="panel" style="display:none">
      <h1>Results</h1>
      <p>
        You correctly matched <span id="score">0</span>/<span class="total">0</span> flashcards
        with the correct answers.
      </p>
      <div class="options">
        <button class="btn action-cancel">Menu</button>
        <button class="btn action-leaderboard online">View leaderboard</button>
      </div>
  </div>

  <div id="leaderboard" class="panel" style="display:none">
    <h1>Leaderboard</h1>
      <p id="leaderboard-set">
        SET
      </p>
      <table id="board" width="100%">
        <thead>
          <th>Place</th><th>Name</th><th>Score</th>
        </thead>
        <tbody>
          <td>--</td><td>-----</td><td>---</td>
        </tbody>
      </table>
      <br>
      <div class="options">
        <button class="btn action-cancel">Menu</button>
      </div>
    </div>
  </div>

  <script src="//cdn.yiays.com/jquery-3.7.1.min.js"></script>
  <script src="/common.js"></script>
  <script>
    let norepeat = [];
    let flashcards = {};
    let setnames = {};
    let set = '';
    let quizmode = false;
    let number = -1;
    let answer;
    let score = 0;

    $().ready(() => {
      let promises = [];
      promises.push($.getJSON('flashcards.json', (data) => {populate_setlist(data)}));
      Promise.all(promises).then((_) => load_complete());

      $('#start').on('click', (e) => {
        $('#menu').hide();
        $('#game').show();
        set = $('#setselect').val();
        norepeat = [];
        
        newquestion();

        return false;
      });

      $('#setselect').on('change', e => {set = e.target.value;on_setchange()});

      $('#quiztoggle').on('change', e => {quizmode = e.target.checked;on_modechange();});

      $('.action-cancel').on('click', menu);

      $('.action-advance').on('click', newquestion);

      $('.action-answer').on('click', showanswer);

      $('.action-leaderboard').on('click', showleaderboard);
    });

    function populate_setlist(data) {
      Object.keys(data).forEach((set) => {
        let keyname = set.toLowerCase().replace(/ - .*/, '').replace(' ','_') + '_' + data[set].length;
        flashcards[keyname] = data[set];
        setnames[keyname] = set;
        $('#setselect').append(`<option value="${keyname}">${set}</option>`);
      });

      if('set' in urlParams) {
        set = urlParams.set;
        on_setchange();
      }
    }

    function newquestion() {
      while(true) {
        number = randint(flashcards[set].length - 1);

        if(norepeat.indexOf(number) >= 0) {
          if(norepeat.length >= flashcards[set].length) {
            if(quizmode)
              endgame();
            else
              toasty("Out of cards!", 10, true);
            return;
          }
          continue;
        }
        norepeat.push(number);
        break;
      }

      $('#question').text(`Card ${norepeat.length} / ${flashcards[set].length}`);
      let question;
      [question, answer] = Object.entries(flashcards[set][number])[0]
      $('#game>.flashcard>.side-a').text(question);
      $('#game>.flashcard>.side-b').text(answer);

      if(quizmode) {
        $('.score').text(score);
        $('#answers .btn').removeClass('disabled').removeClass('correct').removeClass('incorrect');

        let answers = [answer];
        while(answers.length < 4) {
          const i = randint(flashcards[set].length - 1);
          const v = Object.values(flashcards[set][i])[0];
          if(answers.includes(v)) continue;
          answers.push(v);
        }
        shuffle(answers);
        $('#answers > button').each(function(i) {
          this.innerText = answers[i];
          this.style.fontSize = `${1 - Math.min((Math.max(answers[i].length - 12, 0) / 30), 0.3)}em`;
        });
      }

      $('#game>.flashcard').removeClass('flipped');
      $('#game .post').hide();
      $('#game .pre').show();
    }

    function showanswer(e) {
      $('#game>.flashcard').addClass('flipped');
      $('#game .pre').hide();
      $('#game .post').show();

      if(quizmode) {
      $('#answers .btn').addClass('disabled');
        if(e.target.innerText == answer) {
          e.target.classList.add('correct');
          score++;
          $('.score').text(score);
        } else
          e.target.classList.add('incorrect');
      }
    }

    function endgame() {
      $('#game,#menu').hide();
      $('.score').text(score);
      $('.total').text(flashcards[set].length);
      $('#results').show();

      submit_highscore(`flashcards_quiz_${set}`, `${score}`);
    }
    
    function showleaderboard() {
      $('#results,#menu').hide();
      $('#leaderboard').show();

      $('#leaderboard-set').text(`(${setnames[set].toUpperCase()})`);

      get_leaderboard(`flashcards_quiz_${set}`, result_converter=(v) => `${v} points`);
    }

    function menu() {
      $('#game,#leaderboard').hide();
      $('#menu').show();
    }

    function updateUrl() {
      if(!('set' in urlParams) || urlParams.set != set || (quizmode && !('quiz' in urlParams)) || (!quizmode && ('quiz' in urlParams))) {
        window.history.pushState({}, '', document.location.href.split('?')[0]+`?set=${set}${quizmode?'&quiz':''}`);
        updateUrlParams();
      }
    }

    function on_setchange(bubble=true) {
      $('#setselect').val(set);
      if(set == '') {
        $('#start,.action-leaderboard').addClass('disabled');
      } else {
        $('#start,.action-leaderboard').removeClass('disabled');
      }
      if(bubble) updateUrl();
      menu();
    }

    function on_modechange(bubble=true) {
      $('#quiztoggle').attr('checked', quizmode);
      if(quizmode) {
        warn_hs_signin();
        score = 0;
        document.body.classList.add('quiz');
        document.title = "Flashcards Quiz";
      }else{
        document.body.classList.remove('quiz');
        document.title = "Flashcards";
      }
      if(bubble) updateUrl();
      menu();
    }

    var urlParams;
    function updateUrlParams() {
      var match,
        pl     = /\+/g,  // Regex for replacing addition symbol with a space
        search = /([^&=]+)=?([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

      urlParams = {};
      while (match = search.exec(query))
        urlParams[decode(match[1])] = decode(match[2]);
    }

    window.onpopstate = function() {
      updateUrlParams();
      
      if('set' in urlParams && urlParams.set != set) {
        set = urlParams.set;
        on_setchange(false);
      } else if (set != '') {
        set = '';
        on_setchange(false);
      }
      if('quiz' in urlParams && !quizmode) {
        quizmode = true;
        on_modechange(false);
      }else if(!('quiz' in urlParams) && quizmode) {
        quizmode = false;
        on_modechange(false);
      }
    };
    window.onpopstate();
  </script>
</body>
</html>