<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marbles</title>
  <meta name="description" content="Untangle a jumble of marbles into colour groups">
  <meta name="tags" content="colour, sorting, puzzle, challenge">

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" sizes="64x64" href="/ico/64.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/common.css" rel="stylesheet">
  <style>
    :root {
      --ball1: #73d0f6;
      --ball2: #95daf6;
      --ball3: #99bbe3;
      --ball4: #85a7d8;
      --ball5: #807dbb;
      --ball6: #948dc4;
      --ball7: #ab9fce;
      --ball8: #bcafd6;
      --ball9: #cdbfdd;
      --ball10: #e3d7ea;
    }
    #flasks{
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1em;
    }
    .flask{
      position: relative;
    }
    .flask > svg {
      width: 5em;
      height: 10em;
    }
    .flask > * {
      pointer-events: none;
    }
    .marbles{
      display: flex;
      flex-direction: column-reverse;
      gap: 0.1em;
      position: absolute;
      bottom: 1em;
      left: 1.5em;
    }
    .marbles > svg {
      width: 2em;
      height: 2em;
      transform: translateY(0);
      opacity: 1;
      transition: transform 250ms, opacity 250ms;
      animation: dropin 250ms;
    }
    .flask.focus > .marbles > svg:last-child {
      transform: translateY(-10px);
      opacity: 0.6;
    }
    @keyframes dropin {
      0% {
        transform: translateY(-10px);
        opacity: 0.6;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div id="menu" class="panel">
    <h1>Marbles</h1>
    <p>Untangle a jumble of marbles into colour groups</p>
    <button class="big-red btn action-start">Go</button>
    <div class="options" style="margin-top: 1em">
      <a class="btn" href="/">More games</a>
    </div>
  </div>

  <div id="game" class="panel" style="background:rgba(124,114,119,0.6);display:none;">
    <div id="flasks">
    </div>
    <div class="options" style="margin-top: 1em">
      <button class="btn action-retry">Retry</button>
      <button class="btn action-cancel">Return to menu</button>
    </div>
  </div>

  <!-- Symbols for all SVG sprites in this game
    Spritesheet generated from https://codeshack.io/svg-sprite-generator
  -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <defs>
      <style>
        .cls-1,.cls-2 {
          stroke:#4c4245;
          stroke-miterlimit:10;
        }
        .cls-1 {
          stroke-width:3.82px;
        }
        .cls-2 {
          fill:none;
          stroke-width:2px;
        }
        #Tube > .cls-1 {
          fill: none;
        }
      </style>
    </defs>
    <symbol id="icon-jasper" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Jasper"><circle style="fill:var(--ball1);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/><polygon class="cls-2" points="12.41 16.91 15.41 10.91 18.41 16.91 15.41 19.91 12.41 16.91"/></g></g></g>
    </symbol>
    <symbol id="icon-plain" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Plain"><circle style="fill:var(--ball2);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/></g></g></g>
    </symbol>
    <symbol id="icon-trapezoid" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Trapezoid"><circle style="fill:var(--ball3);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/><polygon class="cls-2" points="10.91 19.91 13.91 10.91 16.91 10.91 19.91 19.91 10.91 19.91"/></g></g></g>
    </symbol>
    <symbol id="icon-hex" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Hex"><circle style="fill:var(--ball4);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/><polygon class="cls-2" points="13.35 10.91 17.48 10.91 21.6 15.41 17.48 19.91 13.35 19.91 9.22 15.41 13.35 10.91"/></g></g></g>
    </symbol>
    <symbol id="icon-diamond" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Diamond"><circle style="fill:var(--ball5);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/><rect class="cls-2" x="12.23" y="12.23" width="6.36" height="6.36" transform="translate(-6.38 15.41) rotate(-45)"/></g></g></g>
    </symbol>
    <symbol id="icon-square" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Square"><circle style="fill:var(--ball6);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/><rect class="cls-2" x="10.91" y="10.91" width="9" height="9"/></g></g></g>
    </symbol>
    <symbol id="icon-widow" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Widow"><circle style="fill:var(--ball7);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/><polygon class="cls-2" points="10.91 19.91 19.91 10.91 19.91 19.91 10.91 10.91 10.91 19.91"/></g></g></g>
    </symbol>
    <symbol id="icon-circle" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Circle"><circle style="fill:var(--ball8);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/><circle class="cls-2" cx="15.12" cy="15.12" r="4.21"/></g></g></g>
    </symbol>
    <symbol id="icon-triangle" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Triangle"><circle style="fill:var(--ball9);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/><polygon class="cls-2" points="15.41 10.91 10.91 19.91 19.91 19.91 15.41 10.91"/></g></g></g>
    </symbol>
    <symbol id="icon-cross" viewBox="0 0 30.82 30.82">
    <g id="Layer_2" data-name="Layer 2"><g id="Marbles"><g id="Cross"><circle style="fill:var(--ball10);" class="cls-1" cx="15.41" cy="15.41" r="13.5"/><polygon class="cls-2" points="13.91 13.91 13.91 10.91 16.91 10.91 16.91 13.91 19.91 13.91 19.91 16.91 16.91 16.91 16.91 19.91 13.91 19.91 13.91 16.91 10.91 16.91 10.91 13.91 13.91 13.91"/></g></g></g>
    </symbol>
    <symbol id="icon-tube" viewBox="0 0 81 158.87">
    <g id="Layer_2" data-name="Layer 2"><g id="Tube"><polyline id="Tube-2" data-name="Tube" class="cls-1" points="0 2.93 16.2 2.93 16.2 155.93 64.8 155.93 64.8 2.93 81 2.93"/></g></g>
    </symbol>
  </svg>

  <script src="//cdn.yiays.com/jquery-3.7.1.min.js"></script>
  <script src="/common.js"></script>
  <script>
    const balls = [
      'plain',
      'hex',
      'jasper',
      'cross',
      'trapezoid',
      'widow',
      'diamond',
      'triangle',
      'square',
      'circle'
    ];

    const schemes = {
      'vivid': ['f15758','f5845c','fcb958','fee256','bbd75c','7bc35e','7bcaae','6599d1','6861ab','da61a4'],
      'neutral': ['f2707f','f69375','efb670','f0ca6f','c2db71','91ca69','89cbb5','77abdc','766eb2','ed70a4'],
      'pastel': ['e5adac','f4c7a5','f4d2a4','f2e3a4','d6e6a4','acd79c','addbc3','a5d7f4','bfa4ce','eca5c9'],
      'girlatsea': ['015259','026d77','42999b','82c5be','b8dedc','eef8fa','daf0f2','fdddd3','f5c2b1','e39678'],
      'bayside': ['13293d','1c526f','173e56','fdf7b8','e5d177','13709a','f9e384','3096d3','83c5e8','e9f1f2'],
      'purpleplanet': ['73d0f6','95daf6','99bbe3','85a7d8','807dbb','948dc4','ab9fce','bcafd6','cdbfdd','e3d7ea'],
      'blisteringsun': ['fff26e','efe136','edbe35','d7a928','faa32c','d88328','ec6236','bf4727','a21d21','681219']
    };

    var template, state, undoLog, selectedTube;

    $().ready(() => {
      $('.action-start').on('click', newgame);
      $('.action-retry').on('click', present_template);
      $('.action-cancel').on('click', menu);
    });

    function newgame() {
      const ballsinplay = shuffle(balls).slice(-6);
      const flasks = 8;
      const moves = 50;

      template = ballsinplay.map(a => Array(4).fill(a));
      template = template.concat(Array.from({length: flasks - template.length}, () => []));

      // Try random moves until a legal one is found, then play it
      for (let i=0; i<moves; i++) {
        while(true) {
          let sourceflask = randint(flasks - 1);
          let targetflask = randint(flasks - 1);
          if(sourceflask!=targetflask && template[sourceflask].length > 0 && template[targetflask].length < 4) {
            if(template[sourceflask].at(-1) === undefined)
              console.error("Undefined marble encountered!");
            template[targetflask].push(template[sourceflask].pop());
            break;
          }
        }
      }

      // Fill marbles to the left until each flask is full again
      for(let i=0; i<ballsinplay.length; i++) {
        while(template[i].length < 4) {
          let popped = undefined;
          for(let j=flasks-1; j>ballsinplay.length-1; j--) {
            popped = template[j].pop();
            if(popped) {
              template[i].push(popped);
              break;
            }
          }
        }
      }

      present_template();
      
      $('#menu').hide();
      $('#game').show();
    }

    function present_template() {
      // Reinit the game with the template
      $('#flasks').empty();

      let out = '';
      template.forEach(flask => {
        out += `
          <button type="button" class="flask nobtn" title="Flask">
            <svg width="81" height="160"><use href="#icon-tube"></use></svg>
            <span class="marbles">`;
        flask.forEach(marble => {
          out += `
              <svg width="31" height="31"><use href="#icon-${marble}"></use></svg>`;
        })
        out += `
            </span>
          </button>`;
      });

      $('#flasks').html(out);
      $('.flask').on('click', flask_click);
      state = template.map(i => i.slice());
      undoLog = [];
      selectedTube = undefined;
    }

    function gameRules(from, to) {
      if(state[from].length <= 0) return false;
      if(state[to].length > 0) {
        if(state[to][state[to].length - 1] != state[from][state[from].length - 1])
          return false;
        if(state[to].length >= 4)
          return false;
      }
      return true;
    }

    function flask_click(e) {
      const lastTube = selectedTube;
      selectedTube = $(e.target).index();

      if(lastTube == selectedTube || lastTube === undefined) {
        if(state[selectedTube].length > 0) {
          $(e.target).toggleClass('focus');
          if(!e.target.classList.contains('focus'))
            selectedTube = undefined;
        }
        else
          selectedTube = undefined;
        return;
      }
      $('#flasks').children().eq(lastTube).removeClass('focus');

      while(gameRules(lastTube, selectedTube)) {
        const movemarble = $('#flasks').children().eq(lastTube).find('.marbles > svg:last-child');
        const newflaskcontainer = $(e.target).find('.marbles');
        const belowmarble = newflaskcontainer.find('svg:last-child');
        movemarble.appendTo(newflaskcontainer);
        state[selectedTube].push(state[lastTube].pop());
        undoLog.push(state.map(i => i.slice()));
      }
      selectedTube = undefined;
    }

    function menu() {
      $('#game').hide();
      $('#menu').show();
    }
  </script>
</body>
</html>